---
title: "Let's try: Terraform part 9 - Dynamic"
layout: post
author: bluebirz
description:
# date: 
categories: [devops, IaaC]
tags: [Terraform, let's try]
comment: true
series:
  key: terraform
  index: 9
image:
  path: assets/img/features/external/Blueprint-of-Home.jpg
  lqip: ../assets/img/features/lqip/external/Blueprint-of-Home.webp
  alt: DFD HOUSE PLANS BLOG
  caption: <a href="https://www.dfdhouseplans.com/blog/category/house-plans/">DFD HOUSE PLANS BLOG</a>
---

{% include bbz_custom/expand_series.html key=page.series.key index=page.series.index %}

There is a situation we need to create a resource with complex nested blocks then we can consider this block type to facilitate the flexibility of our code.

It's `dynamic` block.

---

## `dynamic` block

`dynamic` block is used to generate multiple nested blocks within a resource or module based on a collection of values. It allows you to create complex configurations dynamically, making your Terraform code more flexible and reusable.

However, using too many `dynamic` blocks can cause readability problems from ...

---

## Syntax

`dynamic` block must have `content` block inside with `for_each`.

Read more about `for_each` in [part 8 - Conditions and Repetition]({% post_url 2025-08-24-try-terraform-part-8 %}).

```terraform
resource "<resource_type>" "<resource_name>" {
  ...
  dynamic "<block_type>" {
    for_each = <expression>
    iterator = <iterator_name> # optional, default is "<block_type>"
    content {
      attribute_1 = "<value>"
      attribute_2 = "<value>"
      ...
    }
  }
  ...
}
```

---

```terraform
variable "buckets" {
  type = map(object({
    name              = string
    delete_after_days = optional(number)
  }))
}


resource "google_storage_bucket" "bucket" {
  for_each = var.buckets
  name     = each.value.name
  location = "US"
  dynamic "lifecycle_rule" {
    for_each = each.value.delete_after_days != null ? [each.value.delete_after_days] : []
    content {
      action {
        type = "Delete"
      }
      condition {
        age = lifecycle_rule.value
      }
    }
  }
}
```

```terraform
buckets = {
  test1 = {
    name = "bluebirz-tf9-test-1"
  },
  test2 = {
    name              = "bluebirz-tf9-test-2"
    delete_after_days = 30
  },
}
```

```text
Terraform will perform the following actions:

  # google_storage_bucket.bucket["test1"] will be created
  + resource "google_storage_bucket" "bucket" {
      + bucket_policy_only          = (known after apply)
      + force_destroy               = false
      + id                          = (known after apply)
      + location                    = "US"
      + name                        = "bluebirz-tf9-test-1"
      + project                     = (known after apply)
      + self_link                   = (known after apply)
      + storage_class               = "STANDARD"
      + uniform_bucket_level_access = (known after apply)
      + url                         = (known after apply)
    }

  # google_storage_bucket.bucket["test2"] will be created
  + resource "google_storage_bucket" "bucket" {
      + bucket_policy_only          = (known after apply)
      + force_destroy               = false
      + id                          = (known after apply)
      + location                    = "US"
      + name                        = "bluebirz-tf9-test-2"
      + project                     = (known after apply)
      + self_link                   = (known after apply)
      + storage_class               = "STANDARD"
      + uniform_bucket_level_access = (known after apply)
      + url                         = (known after apply)

      + lifecycle_rule {
          + action {
              + type          = "Delete"
                # (1 unchanged attribute hidden)
            }
          + condition {
              + age                    = 30
              + matches_storage_class  = []
              + with_state             = (known after apply)
                # (3 unchanged attributes hidden)
            }
        }
    }

Plan: 2 to add, 0 to change, 0 to destroy.
```

---

```terraform
variable "buckets" {
  type = map(object({
    name = string
  }))
}

variable "bucket_lifecycle_rules" {
  default = null
  type = object({
    age    = number
    action = string
  })
}


resource "google_storage_bucket" "bucket" {
  for_each = var.buckets
  name     = each.value.name
  location = "US"
  dynamic "lifecycle_rule" {
    for_each = var.bucket_lifecycle_rules == null ? [] : [var.bucket_lifecycle_rules]
    content {
      action {
        type = var.bucket_lifecycle_rules.action
      }
      condition {
        age = var.bucket_lifecycle_rules.age
      }
    }
  }
}
```

```terraform
buckets = {
  test1 = {
    name = "bluebirz-tf9-test-1"
  },
  test2 = {
    name = "bluebirz-tf9-test-2"
  },
}

bucket_lifecycle_rules = {
  age    = 30
  action = "Delete"
}
```

```text
Terraform will perform the following actions:

  # google_storage_bucket.bucket["test1"] will be created
  + resource "google_storage_bucket" "bucket" {
      + bucket_policy_only          = (known after apply)
      + force_destroy               = false
      + id                          = (known after apply)
      + location                    = "US"
      + name                        = "bluebirz-tf9-test-1"
      + project                     = (known after apply)
      + self_link                   = (known after apply)
      + storage_class               = "STANDARD"
      + uniform_bucket_level_access = (known after apply)
      + url                         = (known after apply)

      + lifecycle_rule {
          + action {
              + type          = "Delete"
                # (1 unchanged attribute hidden)
            }
          + condition {
              + age                    = 30
              + matches_storage_class  = []
              + with_state             = (known after apply)
                # (3 unchanged attributes hidden)
            }
        }
    }

  # google_storage_bucket.bucket["test2"] will be created
  + resource "google_storage_bucket" "bucket" {
      + bucket_policy_only          = (known after apply)
      + force_destroy               = false
      + id                          = (known after apply)
      + location                    = "US"
      + name                        = "bluebirz-tf9-test-2"
      + project                     = (known after apply)
      + self_link                   = (known after apply)
      + storage_class               = "STANDARD"
      + uniform_bucket_level_access = (known after apply)
      + url                         = (known after apply)

      + lifecycle_rule {
          + action {
              + type          = "Delete"
                # (1 unchanged attribute hidden)
            }
          + condition {
              + age                    = 30
              + matches_storage_class  = []
              + with_state             = (known after apply)
                # (3 unchanged attributes hidden)
            }
        }
    }

Plan: 2 to add, 0 to change, 0 to destroy.
```

---

## References

- <https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks>
- <https://kodekloud.com/blog/terraform-dynamic-block/>
